name: Build LibreELEC for RK3328 L1Pro

on:
  workflow_dispatch:
    inputs:
      librelec_version:
        description: 'LibreELEC Version'
        required: true
        default: '12.0'
        type: string
      kernel_version:
        description: 'Kernel Version'
        required: true
        default: '6.6.y'
        type: string

env:
  PROJECT: "Rockchip"
  ARCH: "aarch64"
  DEVICE_TREE: "rk3328-l1pro-1296mhz"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build LibreELEC
        run: |
          LIBREELEC_VERSION="${{ github.event.inputs.librelec_version }}"
          KERNEL_VERSION="${{ github.event.inputs.kernel_version }}"
          
          docker run --rm \
            --privileged \
            -v $(pwd):/build \
            -w /build \
            libreelec/build-env:latest /bin/bash -c "
            set -e
            
            echo '=== Cloning LibreELEC ==='
            if [ ! -d LibreELEC.tv ]; then
              git clone https://github.com/LibreELEC/LibreELEC.tv
            fi
            
            cd LibreELEC.tv
            git checkout \$LIBREELEC_VERSION
            
            echo '=== Setting up build environment ==='
            ./scripts/setup
            
            echo '=== Integrating custom device tree ==='
            # 查找内核目录
            KERNEL_DIR=\$(find projects/$PROJECT -name 'linux-*' -type d | head -1)
            if [ -z \"\$KERNEL_DIR\" ]; then
              echo 'Kernel directory not found!'
              exit 1
            fi
            
            echo \"Using kernel directory: \$KERNEL_DIR\"
            
            # 复制设备树到正确位置
            DTS_DEST=\"\$KERNEL_DIR/arch/arm64/boot/dts/rockchip/\"
            if [ -d \"\$DTS_DEST\" ]; then
              cp /build/rk3328-l1pro-1296mhz.dts \"\$DTS_DEST\"
              if [ -f /build/rk3328.dtsi ]; then
                cp /build/rk3328.dtsi \"\$DTS_DEST\"
              fi
              
              # 添加到设备树 Makefile
              if [ -f \"\$DTS_DEST/Makefile\" ]; then
                if ! grep -q \"rk3328-l1pro-1296mhz.dtb\" \"\$DTS_DEST/Makefile\"; then
                  echo 'dtb-\\$(CONFIG_ARCH_ROCKCHIP) += rk3328-l1pro-1296mhz.dtb' >> \"\$DTS_DEST/Makefile\"
                  echo 'Added rk3328-l1pro-1296mhz.dtb to Makefile'
                fi
              else
                echo 'Warning: DTS Makefile not found at expected location'
              fi
            else
              echo \"Error: DTS destination directory not found: \$DTS_DEST\"
              exit 1
            fi
            
            echo '=== Building image ==='
            # 构建 Rockchip 镜像
            PROJECT=Rockchip ARCH=aarch64 make image
            
            echo '=== Build completed ==='
          "

      - name: Prepare artifacts
        run: |
          cd LibreELEC.tv
          
          # 查找生成的镜像文件
          IMG_FILE=$(find target -name "LibreELEC-*.img.gz" -type f | head -1)
          if [ -z "$IMG_FILE" ]; then
            echo "No .img.gz file found, checking for .img files..."
            IMG_FILE=$(find target -name "LibreELEC-*.img" -type f | head -1)
            if [ -n "$IMG_FILE" ]; then
              echo "Compressing .img file..."
              gzip "$IMG_FILE"
              IMG_FILE="${IMG_FILE}.gz"
            fi
          fi
          
          if [ -z "$IMG_FILE" ]; then
            echo "Error: No built image found!"
            find target -type f | head -20
            exit 1
          fi
          
          # 创建有意义的文件名
          VERSION=${IMG_FILE##*LibreELEC-}
          VERSION=${VERSION%.img*}
          cp "$IMG_FILE" "../LibreELEC-RK3328-L1Pro-${VERSION}.img.gz"
          echo "Artifact: LibreELEC-RK3328-L1Pro-${VERSION}.img.gz"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: LibreELEC-RK3328-L1Pro
          path: LibreELEC-RK3328-L1Pro-*.img.gz
          retention-days: 30

      - name: Show build info
        run: |
          echo "=== Build Completed Successfully ==="
          echo "LibreELEC Version: ${{ github.event.inputs.librelec_version }}"
          echo "Kernel Version: ${{ github.event.inputs.kernel_version }}"
          echo "Device: RK3328 L1Pro"
          echo "Architecture: aarch64"
          echo "Custom Device Tree: rk3328-l1pro-1296mhz.dts"
