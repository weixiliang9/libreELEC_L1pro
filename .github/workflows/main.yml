name: Build LibreELEC for RK3328 L1Pro

on:
  workflow_dispatch:
    inputs:
      le_periodic_version:
        description: "Version and Periodic builds"
        default: nightly
        required: true
        type: choice
        options:
          - nightly
          - official
      gitref_to_build:
        description: "gitref tag or hash to build"
        default: libreelec-12.0
        required: true
        type: string

env:
  clean_le: no_clean_le
  debug: debug
  ephemeral: ephemeral
  upload: upload

jobs:
  setup_custom_device_tree:
    runs-on: ubuntu-latest
    name: Setup Custom Device Tree
    outputs:
      dts_setup_complete: ${{ steps.setup.outputs.dts_setup_complete }}
    steps:
      - name: Checkout repository with device tree
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Verify device tree files
        id: verify_dts
        run: |
          if [ ! -f "rk3328-l1pro-1296mhz.dts" ]; then
            echo "Error: rk3328-l1pro-1296mhz.dts not found!"
            exit 1
          fi
          echo "Device tree files verified"
          echo "dts_files_present=true" >> $GITHUB_OUTPUT

      - name: Checkout LibreELEC source
        uses: actions/checkout@v5
        with:
          repository: "LibreELEC/LibreELEC.tv"
          ref: ${{ github.event.inputs.gitref_to_build || 'libreelec-12.0' }}
          path: "LibreELEC.tv"

      - name: Integrate custom device tree
        id: setup
        run: |
          cd LibreELEC.tv
          
          # 创建设备树包目录
          mkdir -p projects/Rockchip/packages/device-tree/custom
          
          # 复制设备树文件
          cp ../rk3328-l1pro-1296mhz.dts projects/Rockchip/packages/device-tree/custom/
          if [ -f "../rk3328.dtsi" ]; then
            cp ../rk3328.dtsi projects/Rockchip/packages/device-tree/custom/
          fi
          
          # 创建设备树包配置
          cat > projects/Rockchip/packages/device-tree/custom/package.mk << 'EOF'
          PKG_NAME="custom-device-tree"
          PKG_VERSION="1.0"
          PKG_LICENSE="GPL"
          PKG_SITE=""
          PKG_URL=""
          PKG_DEPENDS_TARGET="toolchain dtc"
          PKG_LONGDESC="Custom device tree for RK3328 L1Pro"
          
          makeinstall_target() {
            mkdir -p \$INSTALL/usr/share/bootloader
            dtc -I dts -O dtb -o \$INSTALL/usr/share/bootloader/rk3328-l1pro-1296mhz.dtb rk3328-l1pro-1296mhz.dts
          }
          EOF
          
          # 添加到项目包列表
          if ! grep -q "custom-device-tree" projects/Rockchip/options; then
            echo "ADDITIONAL_PACKAGES+=\" custom-device-tree\"" >> projects/Rockchip/options
          fi
          
          echo "Custom device tree integration completed"
          echo "dts_setup_complete=true" >> $GITHUB_OUTPUT

  build_rk3328_custom:
    name: "RK3328 L1Pro Custom"
    needs: setup_custom_device_tree
    if: needs.setup_custom_device_tree.outputs.dts_setup_complete == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout LibreELEC source
        uses: actions/checkout@v5
        with:
          repository: "LibreELEC/LibreELEC.tv"
          ref: ${{ github.event.inputs.gitref_to_build || 'libreelec-12.0' }}
          path: "LibreELEC.tv"

      - name: Restore custom device tree setup
        run: |
          # 复用之前设置的设备树
          cd LibreELEC.tv
          mkdir -p projects/Rockchip/packages/device-tree/custom
          cp ../rk3328-l1pro-1296mhz.dts projects/Rockchip/packages/device-tree/custom/
          if [ -f "../rk3328.dtsi" ]; then
            cp ../rk3328.dtsi projects/Rockchip/packages/device-tree/custom/
          fi
          
          cat > projects/Rockchip/packages/device-tree/custom/package.mk << 'EOF'
          PKG_NAME="custom-device-tree"
          PKG_VERSION="1.0"
          PKG_LICENSE="GPL"
          PKG_SITE=""
          PKG_URL=""
          PKG_DEPENDS_TARGET="toolchain dtc"
          PKG_LONGDESC="Custom device tree for RK3328 L1Pro"
          
          makeinstall_target() {
            mkdir -p \$INSTALL/usr/share/bootloader
            dtc -I dts -O dtb -o \$INSTALL/usr/share/bootloader/rk3328-l1pro-1296mhz.dtb rk3328-l1pro-1296mhz.dts
          }
          EOF
          
          echo "ADDITIONAL_PACKAGES+=\" custom-device-tree\"" >> projects/Rockchip/options

      - name: Setup build environment
        run: |
          cd LibreELEC.tv
          ./scripts/setup

      - name: Build LibreELEC image
        run: |
          cd LibreELEC.tv
          PROJECT=Rockchip \
          ARCH=aarch64 \
          DEVICE=RK3328 \
          make image

      - name: Find and rename built image
        run: |
          cd LibreELEC.tv
          # 查找生成的镜像文件
          IMG_FILE=$(find target -name "LibreELEC-RK3328*.img.gz" -type f | head -1)
          if [ -z "$IMG_FILE" ]; then
            echo "No image file found, checking for uncompressed images..."
            IMG_FILE=$(find target -name "LibreELEC-RK3328*.img" -type f | head -1)
            if [ -n "$IMG_FILE" ]; then
              echo "Compressing image..."
              gzip "$IMG_FILE"
              IMG_FILE="${IMG_FILE}.gz"
            fi
          fi
          
          if [ -z "$IMG_FILE" ]; then
            echo "Error: No built image found!"
            find target -type f -name "*.img*" | head -10
            exit 1
          fi
          
          # 重命名为自定义名称
          CUSTOM_NAME="LibreELEC-RK3328-L1Pro-Custom-${GITHUB_RUN_NUMBER}.img.gz"
          cp "$IMG_FILE" "../$CUSTOM_NAME"
          echo "CUSTOM_IMAGE=$CUSTOM_NAME" >> $GITHUB_ENV
          echo "Image prepared: $CUSTOM_NAME"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: LibreELEC-RK3328-L1Pro-Custom
          path: LibreELEC-RK3328-L1Pro-Custom-*.img.gz
          retention-days: 30

      - name: Create GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: LibreELEC-RK3328-L1Pro-Custom-*.img.gz
          generate_release_notes: true

  build_using_official_action:
    name: "RK3328 Official Action Method"
    needs: setup_custom_device_tree
    if: needs.setup_custom_device_tree.outputs.dts_setup_complete == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Build using official LibreELEC action
        uses: libreelec/actions/build@main
        with:
          version: "12.0"
          project: "Rockchip"
          device: "RK3328"
          arch: "aarch64"
          # 传递自定义参数
          custom_packages: "custom-device-tree"
          additional_options: "ADDITIONAL_PACKAGES+=\" custom-device-tree\""

      - name: Rename and upload official build
        run: |
          # 假设官方action输出的文件在特定位置
          if [ -f "LibreELEC-RK3328*.img.gz" ]; then
            cp LibreELEC-RK3328*.img.gz "LibreELEC-RK3328-L1Pro-Official-${GITHUB_RUN_NUMBER}.img.gz"
          fi

      - name: Upload official artifact
        uses: actions/upload-artifact@v4
        with:
          name: LibreELEC-RK3328-L1Pro-Official
          path: LibreELEC-RK3328-L1Pro-Official-*.img.gz
          retention-days: 30
